```{r}
library(here)
library(dplyr)
library(leaflet)
```

```{R}
data_folder <- here("data", "dore")
dore_df <- read.table(file.path(data_folder, "interaction-data.txt"), sep = "\t", header = TRUE)
dore_networks_matrices <- readRDS(file.path(data_folder, "dore_networks_matrices.Rds"))
dore_aggregated_networks_matrices <- readRDS(file.path(data_folder, "dore_aggregated_networks_matrices.Rds"))
dore_supinfo <- read.csv(file.path(data_folder, "dore_supinfo.csv")) |>
    mutate(Longitude_dec = Longitude_dec |> gsub(pattern = ",", replacement = ".") |> as.numeric(), Latitude_dec = Latitude_dec |> gsub(pattern = ",", replacement = ".") |> as.numeric())
```

Chamberlain et al semble intéressant pour notre cas:
```{r}
dore_supinfo[dore_supinfo$Short_ref |> grepl(pattern = "Chamberlain"), ]
```
En effet il y a une étude de Chamberlain et al qui donnent 3 groupes de réseaux.

```{r echo=TRUE, fig.cap="Table pour Chamberlain et al avec les métadonnées des 3 réseaux aggrégés", results="asis"}
library(knitr)
chamberlain_supinfo <- dore_supinfo[dore_supinfo$Idweb %in% c(61, 62, 64), ]
kable(
    dore_supinfo[dore_supinfo$Idweb %in% c(61, 62, 64), -27]
)
```

```{r}
leaflet() %>%
    addTiles() %>%
    # setView(lng = -3.7, lat = 40.4, zoom = 5) %>%
    addMarkers(lat = chamberlain_supinfo$Latitude_dec, lng = chamberlain_supinfo$Longitude_dec, label = paste(chamberlain_supinfo$Location, chamberlain_supinfo$Idweb))
```

```{r}
chamberlain_aggr_bool <- names(dore_aggregated_networks_matrices) |> grepl(pattern = "Chamberlain")
chamberlain_aggr_networks <- dore_aggregated_networks_matrices[chamberlain_aggr_bool]
chamberlain_bool <- names(dore_networks_matrices) |> grepl(pattern = "Chamberlain")
chamberlain_networks <- dore_networks_matrices[chamberlain_bool]

chamberlain_aggr_networks <- lapply(chamberlain_aggr_networks, function(mat) {
    mat[mat > 1] <- 1
    return(mat)
})
chamberlain_networks <- lapply(chamberlain_networks, function(mat) {
    mat[mat > 1] <- 1
    return(mat)
})
```

```{r}
library(future)
plan("multisession")
library(colSBM)
fit <- estimate_colBiSBM(netlist = chamberlain_aggr_networks, net_id = names(chamberlain_aggr_networks), colsbm_model = "iid", global_opts = list(verbosity = 2))
plot(fit)
fit2plot <- fit$clone()
fit2plot$best_fit$net_id <- paste0(rep("Chamberlain", 3), seq(1, 3))
plot(fit2plot$best_fit, type = "meso", mixture = TRUE, values = TRUE)
```